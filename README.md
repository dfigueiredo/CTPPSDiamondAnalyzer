<b>Installation:</b>

While the new unpacker and the updated xml file is not included in the official CMSSW repo, use the instructions below. Please, check with CT-PPS software off-line experts.

```
cmsrel CMSSW_9_2_6
cd CMSSW_9_2_6/src
cmsenv
git cms-init
git cms-merge-topic CTPPS:diamond_unpacker_afterTS1_2017
git cms-addpkg EventFilter/CTPPSRawToDigi
git cms-addpkg CondFormats/CTPPSReadoutObjects
cd CondFormats/CTPPSReadoutObjects/xml
wget -q -N https://raw.githubusercontent.com/cms-sw/cmssw/master/CondFormats/CTPPSReadoutObjects/xml/mapping_timing_diamond_2017.xml
cd $CMSSW_BASE/src
git clone https://github.com/dfigueiredo/CTPPSDiamondAnalyzer.git
scram b -j 8
```

If you are using the latest CMSSW release which include them:

```
cmsrel CMSSW_9_2_6
cd CMSSW_9_2_6/src
cmsenv
git cms-init
git cms-addpkg EventFilter/CTPPSRawToDigi
git cms-addpkg CondFormats/CTPPSReadoutObjects
cd $CMSSW_BASE/src
git clone https://github.com/dfigueiredo/CTPPSDiamondAnalyzer.git
scram b -j 8
```

<b>Configuration for dat files:</b>

Edit a python script to generate a list of files from a specific path (i.e RunXXXYYY).
i.e: /store/t0streamer/Data/PhysicsCommissioning/000/XXX/YYY/

```
cd $CMSSW_BASE/src/CTPPSDiamondAnalyzer/Skimmer/test
python generateFiles.py (it will generate the file python/AutoGenerate_cff.py that includes the list of files in t0streamer)
```

Edit the file RunMonitor.py, and keep lines as below:

```
#PluginSource = "PoolSource" # RAW
PluginSource = "NewEventStreamFileReader" # dat 
```

In case the dat files are not presented in the t0streamer, you need to run over RAW files.

<b>Configuration for RAW files:</b>

Firstly, in order to find the list of raw files for a given run, you need to open CMS-DAS (https://cmsweb.cern.ch/das/), and search "dataset run=XXXYYY". After that, a list of samples will appear. Choose the sample that contains the name "ZeroBias" and "RAW". Finally, do a search "files dataset=/ZeroBias/RunXXXYYY/RAW", for instance, with the results format selecting plain option. Copy the list of the files for the run you would like to use in the file RunXXXYYY_cff.py (or any other name) keeping the format as AutoGenerated_cff.py.

Therefore, be sure that you are loading the right file in RunMonitor.py (i.e):

```
from CTPPSDiamondAnalyzer.Skimmer.RunXXXYYY_cff import readFiles
process.source = cms.Source (PluginSource, fileNames = cms.untracked.vstring(readFiles))
```

And compile:

```
cd CTPPSDiamondAnalyzer/Skimmer
scram b -j 8 
```

<b>Configuring Running Script</b>

Before run, you need to configure some parameters in RunMonitor.py to setup the fit range you would like to apply (choosing a time window from 0 to 125 ns), the name of the output folder where the plots will be automatically saved or the BX you would like to select the events. They are not mandatory but you need to change for your case. If the range of the fit is not well specified, the fits results sometimes does not work since you are selecting the wrong peak. Always check the fit in the Leading or Trailing Edge distributions to be sure the tool selected the right peak.

```
    bx = cms.untracked.vint32(), #empty vector: no BX selection. You can select a specific BX.
    path = cms.untracked.string("Run300466"),
    # If ufirstHisto == ulastHisto or ( ufirstHisto < 0 || ulastHisto < 0); fit maximum peak from 0 to 125 ns.
    ufirstHisto = cms.double(0), # min X histo, (fit and plot draw). 
    ulastHisto = cms.double(125) # max X histo, (fit and plot draw).
```

<b>Running</b>

First step is to set your grid proxy to be able to access files on grid:

```
voms-proxy-init --voms cms
```

Execute CMSSW:

```
cmsRun CTPPSDiamondAnalyzer/Skimmer/test/RunMonitor.py
```

However, if you would like to submit in lxbatch jobs, configure runJobs.csh and edit for your case. After, do:

```
./sendJob.sh (outputs will be saved on $CMSSW_BASE/src/CTPPSDiamondAnalyzer/Skimmer/test)
```

<b>Copy the Plots to your Private DNS folder in lxplus:</b>

```
cp -r RunXXXYYY /afs/cern.ch/user/U/$USER/public/html/. (or www)
For instance /afs/cern.ch/user/d/dmf/public/html
```

This is accessible from http://cmsdoc.cern.ch/~$USER

You case this does not work, you can create a website on web.cern.ch and point your DNS to a EOS folder. Check cernbox instructions to set a webpage.
